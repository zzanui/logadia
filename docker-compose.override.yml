services:
  web:
    env_file:
      - .env.local
    command: >
      bash -lc "
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      gunicorn config.wsgi:application --bind 0.0.0.0:8000 --reload --timeout 120 --workers 3 --threads 4
      "
    volumes:
      # ğŸ”¥ ë¡œì»¬ Django ì†ŒìŠ¤ì½”ë“œ â†’ ì»¨í…Œì´ë„ˆ /app ì— ë°˜ì˜
      - ./backend:/app
      # ì •ì /ë¯¸ë””ì–´ëŠ” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê´€ë¦¬
      - static:/app/staticfiles
      - media:/app/media
    ports:
      - "8000:8000"

  frontend:
    # ğŸ”¥ ë¡œì»¬ React ë¹Œë“œ ê²°ê³¼ ë˜ëŠ” í”„ëŸ°íŠ¸ ì „ì²´ í´ë” ë°˜ì˜
    ports:
    - "8080:80"
    volumes:
      # ë¡œì»¬ nginx ì„¤ì •
      - ./frontend/dist:/usr/share/nginx/html
      - ./nginx/nginx.local.conf:/etc/nginx/nginx.conf:ro
      - static:/var/www/static:ro
      - media:/var/www/media:ro

  db:
    # ğŸ”¥ ë¡œì»¬ì—ì„œëŠ” ë°ì´í„° ì†ìƒ ë°©ì§€ + ìœˆë„ìš° mount ë¬¸ì œ ë•Œë¬¸ì— named volume ì‚¬ìš© ê·¸ëŒ€ë¡œ
    volumes:
      - ./db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
  

volumes:
  static:
  media:
  pgdata:
